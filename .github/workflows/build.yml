name: Build and Deploy Config Service

on:
  push:
    branches:
      - main

env:
  GCS_BUCKET: "artifacts-java"
  SERVICE: "config"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIAL_JSON }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: sapient-reducer-477808-m0

      - name: Build config service
        run: |
          if [ -f "${SERVICE}/pom.xml" ]; then
            echo "Building ${SERVICE}..."
            cd ${SERVICE}
            mvn clean package -DskipTests
          else
            echo "No pom.xml found for ${SERVICE}, skipping."
            exit 1
          fi

      - name: Push JAR to GCS
        run: |
          # Look for a regular repackaged jar (skip *sources.jar, *javadoc.jar, etc.)
          JAR=$(ls ${SERVICE}/target/*.jar | grep -v 'sources\|javadoc\|plain' | head -n 1)
          if [ -n "$JAR" ]; then
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            COMMIT=$(git rev-parse --short HEAD)
            ARTIFACT="$(basename ${SERVICE})-${TIMESTAMP}-${COMMIT}.jar"
            echo "Uploading $JAR to gs://${GCS_BUCKET}/${SERVICE}/${ARTIFACT}"
            gsutil cp "$JAR" "gs://${GCS_BUCKET}/${SERVICE}/${ARTIFACT}"
          else
            echo "No jar found for ${SERVICE}, skipping upload."
            exit 1
          fi