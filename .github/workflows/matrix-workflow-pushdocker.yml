name: Build, Scan, and Push Multiple Docker Images from GCS to Docker Hub

on:
  push:
    branches: [main]

jobs:
  build-scan-push:
    runs-on: ubuntu-latest

    # List your microservices, .jar and image names here
    strategy:
      matrix:
        service:
          - name: account-service
            jar: account-service.jar
            port: 6000
          - name: auth-service
            jar: auth-service.jar
            port: 5000
          - name: config
            jar: config.jar
            port: 8888
          - name: gateway
            jar: gateway.jar
            port: 4000
          - name: monitoring
            jar: monitoring.jar
            port: 8080
          - name: notification-service
            jar: notification-service.jar
            port: 8000
          - name: registry
            jar: registry.jar
            port: 8761
          - name: statistics-service
            jar: statistics-service.jar
            port: 7000
          - name: turbine-stream-service
            jar: turbine-stream-service.jar
            port: 8989

    env:
      GCS_BUCKET: artifacts-javas           # Replace with your actual bucket

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIAL_JSON }}
          project_id: sapient-reducer-477808-m0         # Replace with your GCP project

      - name: Download latest JAR from GCS
        run: |
          SERVICE=${{ matrix.service.name }}
          GCS_BUCKET=${{ env.GCS_BUCKET }}
          LATEST_JAR=$(gsutil ls "gs://${GCS_BUCKET}/${SERVICE}/${SERVICE}-*.jar" | sort | tail -n 1)
          echo "Latest artifact: $LATEST_JAR"
          gsutil cp "$LATEST_JAR" app.jar

      - name: Create Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM eclipse-temurin:8-jre
          COPY app.jar /app/app.jar
          CMD ["java", "-Xmx200m", "-jar", "/app/app.jar"]
          EXPOSE ${{ matrix.service.port }}
          EOF

      - name: Build Docker image
        run: |
          docker build -t sandeshsanthu/${{ matrix.service.name }}:latest .

      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: sandeshsanthu/${{ matrix.service.name }}:latest
          format: 'table'
          exit-code: '1'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push image to Docker Hub
        run: |
          docker push sandeshsanthu/${{ matrix.service.name }}:latest